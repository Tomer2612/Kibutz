generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String              @id @default(cuid())
  email                    String              @unique
  name                     String
  password                 String
  createdAt                DateTime            @default(now())
  profileImage             String?
  googleId                 String?             @unique
  lastActiveAt             DateTime?           @default(now())
  showOnline               Boolean             @default(true)
  emailVerificationExpires DateTime?
  emailVerificationToken   String?             @unique
  isEmailVerified          Boolean             @default(false)
  passwordResetExpires     DateTime?
  passwordResetToken       String?             @unique
  bio                      String?
  coverImage               String?
  location                 String?
  notifyComments           Boolean             @default(true)
  notifyCommunityJoins     Boolean             @default(true)
  notifyFollows            Boolean             @default(true)
  notifyLikes              Boolean             @default(true)
  notifyMentions           Boolean             @default(true)
  notifyNewPosts           Boolean             @default(true)
  notifyMessages           Boolean             @default(true)
  posts                    Post[]
  comments                 Comment[]
  communities              Community[]
  bans                     CommunityBan[]
  memberships              CommunityMember[]
  conversationsAsP1        Conversation[]      @relation("ConversationParticipant1")
  conversationsAsP2        Conversation[]      @relation("ConversationParticipant2")
  courseEnrollments        CourseEnrollment[]
  coursesCreated           Course[]
  lessonProgress           LessonProgress[]
  likes                    Like[]
  messagesSent             Message[]
  notificationsSent        Notification[]      @relation("NotificationActor")
  notifications            Notification[]      @relation("NotificationRecipient")
  savedPosts               SavedPost[]
  following                UserFollow[]        @relation("UserFollowing")
  followers                UserFollow[]        @relation("UserFollowers")
  paymentMethods           UserPaymentMethod[]
}

model UserPaymentMethod {
  id           String   @id @default(cuid())
  userId       String
  cardLastFour String
  cardBrand    String   @default("Visa")
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_payment_methods")
}

model UserFollow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowers", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@map("user_follows")
}

model Notification {
  id          String           @id @default(cuid())
  type        NotificationType
  recipientId String
  actorId     String?
  postId      String?
  communityId String?
  commentId   String?
  message     String?
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  actor       User?            @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  recipient   User             @relation("NotificationRecipient", fields: [recipientId], references: [id], onDelete: Cascade)

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt])
  @@map("notifications")
}

model Community {
  id             String            @id @default(cuid())
  name           String
  description    String
  ownerId        String
  createdAt      DateTime          @default(now())
  image          String?
  topic          String?
  memberCount    Int               @default(0)
  facebookUrl    String?
  galleryImages  String[]
  galleryVideos  String[]
  instagramUrl   String?
  whatsappUrl    String?
  youtubeUrl     String?
  rules          String[]
  price          Float?            @default(0)
  logo           String?
  cardBrand      String?
  cardLastFour   String?
  trialCancelled Boolean           @default(false)
  trialStartDate DateTime?
  slug           String?           @unique
  posts          Post[]
  owner          User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  bans           CommunityBan[]
  members        CommunityMember[]
  courses        Course[]
  events         Event[]

  @@map("communities")
}

model CommunityMember {
  id          String     @id @default(cuid())
  userId      String
  communityId String
  joinedAt    DateTime   @default(now())
  role        MemberRole @default(USER)
  community   Community  @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@map("community_members")
}

model CommunityBan {
  id          String    @id @default(cuid())
  userId      String
  communityId String
  bannedAt    DateTime  @default(now())
  expiresAt   DateTime
  reason      String?
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, communityId])
  @@map("community_bans")
}

model Post {
  id          String      @id @default(cuid())
  content     String
  createdAt   DateTime    @default(now())
  authorId    String
  communityId String
  title       String?
  isPinned    Boolean     @default(false)
  pinnedAt    DateTime?
  files       Json[]
  images      String[]
  links       String[]
  category    String?
  author      User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  community   Community   @relation(fields: [communityId], references: [id], onDelete: Cascade)
  comments    Comment[]
  likes       Like[]
  poll        Poll?
  savedBy     SavedPost[]
}

model Poll {
  id        String       @id @default(cuid())
  question  String
  postId    String       @unique
  createdAt DateTime     @default(now())
  expiresAt DateTime?
  options   PollOption[]
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("polls")
}

model PollOption {
  id     String     @id @default(cuid())
  text   String
  pollId String
  poll   Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  votes  PollVote[]

  @@map("poll_options")
}

model PollVote {
  id        String     @id @default(cuid())
  optionId  String
  oderId    String
  createdAt DateTime   @default(now())
  option    PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([optionId, oderId])
  @@map("poll_votes")
}

model Like {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("likes")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  userId    String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model SavedPost {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  userId    String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("saved_posts")
}

model Event {
  id            String      @id @default(cuid())
  title         String
  description   String?
  coverImage    String?
  date          DateTime
  endDate       DateTime?
  duration      Int?
  timezone      String      @default("Asia/Jerusalem")
  isRecurring   Boolean     @default(false)
  recurringType String?
  locationType  String      @default("online")
  locationName  String?
  locationUrl   String?
  category      String?
  capacity      Int?
  sendReminders Boolean     @default(true)
  reminderDays  Int         @default(1)
  attendeeType  String      @default("all")
  communityId   String
  createdById   String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  rsvps         EventRsvp[]
  community     Community   @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@map("events")
}

model EventRsvp {
  id        String     @id @default(cuid())
  eventId   String
  userId    String
  status    RsvpStatus @default(GOING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_rsvps")
}

model Conversation {
  id              String    @id @default(cuid())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  participant1Id  String
  participant2Id  String
  lastMessageAt   DateTime?
  lastMessageText String?
  participant1    User      @relation("ConversationParticipant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2    User      @relation("ConversationParticipant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages        Message[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id])
  @@index([participant2Id])
  @@map("conversations")
}

model Message {
  id             String       @id @default(cuid())
  content        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  isRead         Boolean      @default(false)
  senderId       String
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

model Course {
  id          String             @id @default(cuid())
  title       String
  description String
  image       String?
  duration    Int                @default(0)
  isPublished Boolean            @default(false)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  communityId String
  authorId    String
  chapters    Chapter[]
  enrollments CourseEnrollment[]
  author      User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  community   Community          @relation(fields: [communityId], references: [id], onDelete: Cascade)

  @@index([communityId])
  @@map("courses")
}

model Chapter {
  id       String   @id @default(cuid())
  title    String
  order    Int      @default(0)
  courseId String
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lessons  Lesson[]

  @@index([courseId])
  @@map("chapters")
}

model Lesson {
  id           String           @id @default(cuid())
  title        String
  content      String?
  videoUrl     String?
  duration     Int              @default(0)
  order        Int              @default(0)
  chapterId    String
  files        Json[]
  images       String[]
  lessonType   String           @default("content")
  links        String[]
  contentOrder String[]         @default(["video", "text", "links", "images"])
  progress     LessonProgress[]
  quiz         LessonQuiz?
  chapter      Chapter          @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@map("lessons")
}

model LessonQuiz {
  id        String               @id @default(cuid())
  lessonId  String               @unique
  questions LessonQuizQuestion[]
  lesson    Lesson               @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@map("lesson_quizzes")
}

model LessonQuizQuestion {
  id           String             @id @default(cuid())
  question     String
  questionType String             @default("radio")
  order        Int                @default(0)
  quizId       String
  options      LessonQuizOption[]
  quiz         LessonQuiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@map("lesson_quiz_questions")
}

model LessonQuizOption {
  id         String             @id @default(cuid())
  text       String
  isCorrect  Boolean            @default(false)
  order      Int                @default(0)
  questionId String
  question   LessonQuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("lesson_quiz_options")
}

model CourseEnrollment {
  id          String    @id @default(cuid())
  userId      String
  courseId    String
  progress    Float     @default(0)
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("course_enrollments")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@map("lesson_progress")
}

enum NotificationType {
  LIKE
  COMMENT
  FOLLOW
  NEW_POST
  MENTION
  COMMUNITY_JOIN
}

enum MemberRole {
  OWNER
  MANAGER
  USER
}

enum RsvpStatus {
  GOING
  MAYBE
  NOT_GOING
}
